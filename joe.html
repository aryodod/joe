<!DOCTYPE html>
<html lang="en">
<head>
    <title>joe</title>
    <style>
        #options, #fake, #help {
            display: none;
        }
    </style>
    <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAIAERAAAAEAIACoBAAAJgAAABAQAgABAAEAsAAAAM4EAAAoAAAAEQAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFQwGAB0TDAAiGBAAJBgSAEI5UQCaiq0FmoqtIIuCtjF+fLw1eoHAHXaDwgxucrYCb3K2AFlJOgAzKB0AHhQMAA0GAwAmGhAAMCEWADYmGgA9LiEAmZLOBJeT0B2Wk9CBi4rNxIKCy+mBg8zSf4LLhnqAxzB6gMcKjnZjAF9NPgA4KR4AGQ8HAC0fFgA5KR4AcG+TAG9vkwF/grklgYO8ZYaGwtKCgLz5e3iz/3Bzrv9sc7DzanSy0WBlmHBbW4Mvcmx6BXJsegEWDgcAMCAYADwqIABudJ4JbnSeQWltnpVrbaDnfX2t+Xp5p/9tbpz/Zmib/2FknP9fY579X2Wa9WRplKdycYRJcW+CD05CQAA4LycAipG8A4KHuhyAhLmddnqy4HFzrf+Ghrz/hIS8/3d4tP9na6X/X2Kd/1tdmP9YYJn/W2OT12FmiJRdX3spTUZKB5mjwwKTncgrmaHQbqmu49CrsOf3rLDp/6qs5/+hpOP/lJnd/4iNz/+IjdD/iI7T/3iEyf9pdbTiWGKXqFNciTZJUGsNnKfLCZqj0FedpdO9q7Le76Wq1P+bnMb/o6bW/52j2P+Rm9T/i5TM/4+Yzv+SnNL/hJLN/3KBvf9hb6vnXGqggllnmTSCj7cMi5nIXoyZyMeMl8LxgIiw/3F1nf96f7P/e4K7/3Z+uP9mbZv/ZWuY/2xzpP90grn/bn62/2Jzq+tXcaqWUm+qQJervFaOnb2ripbB95Ki0P2Wotb/l57X/5CZ2P+Tm9z/mJ7f/5SZ1/+EjMf/b320/2l7sf9tfrH/cICx7l51q6VVcKlKkqS8Do6fylaPoM+1lKfc7Zys5f+lsOz/pK7r/5+o5v+YoeD/jZjb/36O0P9whcP/a3+4/26Bsf1vgq3oXXeomVNxpkKZo8gCmKfaPJuq3pOltezlr7zz/7nD9/+6wvb/tr70/6628f+gqer/jJvd/3eLy/9ugbr/aXyr82V5nclifJ9LX4ChFa+41AemsdxOprLgr6u46+yzwPH/u8f1/7rG8/+1wfH/rrrv/6Ku6/+TouL/gJXU/2+Guf9of6nwZXygwWF9n0JcfZ4RsLvTAam21zKqttl/rbfg27K75vy4wOv/t8Hp/7bC6P+zweX/rLrg/5+u1v+Mn8n/eZG4/2+Msd5oiq6hZIiuMFqFrglygYgApbLKDau40y+yv92Ys8Hf1bPC4Pe0wuD9ssHf/7DB3f+wwdv/qbvW/p2yz/mJosbne5rApWqTulZnkbkUS4KwAWd2fQCLqMMAk7PQA5S00RGau9gynb3bX6G/3ZOjv92qor3bspu516mTtdOUirDPc4Gnyzt4oMgZZJTFA2SUxQEFQF4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4D4AA8AeAAOAAgADAAIAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAMAAgAD//4AAKAAAABAAAAAgAAAAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD85NgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" type="image/x-icon">
</head>
<body>
    <div id="options">
        <button id="add">Add Joe to Chrome!</button><br>
        <div id="help">
            <ol>
                <li>Copy this URL <a id="url" href=""></a></li>
                <li>Edit search engines in chrome settings <a href="chrome://settings/searchEngines">chrome://settings/searchEngines</a></li>
                <li>Click the "Add" button</li>
                <li>For "Search Engine", type "Joe"<br>For "keyword", type "j" or your choice of activation keyword.<br>For "URL with %s in place of query",
                enter the copied URL<br>For "Suggestions URL with %s in place of query", enter this url <a href="https://duckduckgo.com/ac/?q=%s&amp;type=list">https://duckduckgo.com/ac/?q=%s&amp;type=list</a></li>
                <li>All done! You can now use Joe by typing "j" (or your keyword) into the Omnibox, pressing space, and typing in a query.</li>
            </ol>
        </div><br><br><br>
        <textarea id="blacklist" placeholder="Return/newline separated list of domains to not proxy" cols="30" rows="10"></textarea><br><br>
        <button id="blacklist-btn">Set domain blacklist</button><br><br><br>

        <input id="corrosion" placeholder="Corrosion instance (https://corrosion.test/service/)" type="text"><br><br>
        <button id="corrosion-btn">Set Corrosion instance</button><br><br><br>

        <select id="search">
            <option id="google" value="google">Google</option>
            <option id="ddg" value="ddg">Duckduckgo</option>
            <option id="bing" value="bing">Bing</option>
            <option id="startpage" value="startpage">Startpage</option>
            <option id="searx" value="searx">Searx</option>
            <option id="metager" value="metager">Metager</option>
            <option id="brave" value="brave">Brave</option>
            <option id="custom" value="custom">Custom</option>
        </select><br><br>
        <button id="search-btn">Set search engine</button><br><br><br>

        <select id="encoding">
            <option id="xor" value="xor">XOR</option>
            <option id="b64" value="b64">Base64</option>
            <option id="plain" value="plain">Plain</option>
        </select><br><br>
        <button id="encoding-btn">Set Corrosion URL encoding</button><br><br><br>
    </div>
    <div id="loading"></div>

    <script>
        // XOR encoding function borrowed from Corrosion :)
function xor(str) {
    return encodeURIComponent(str.toString().split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt() ^ 2) : char).join(''));
}

function setBlacklist(text) {
    const blacklist_array = text.split("\n");

    // Storing an array in localStorage with JSON to string method
    localStorage.setItem('blacklist', JSON.stringify(blacklist_array));
}

function setCorrosion(text) {
    localStorage.setItem('corrosion', text);
}

function setEncoding(text) {
    localStorage.setItem('encoding', text);
}

function setSearch(search_value) {
    let search_url = '';

    switch(search_value) {
        case "google":
            search_url = 'https://www.google.com/search?q=%s'
            break;
        case "ddg":
            search_url = 'https://duckduckgo.com/?q=%s';
            break;
        case "bing":
            search_url = 'https://www.bing.com/search?q=%s';
            break;
        case "startpage":
            search_url = 'https://www.startpage.com/do/search?q=%s';
            break;
        case "searx":
            search_url = 'https://searx.be/?q=%s';
            break;
        case "metager":
            search_url = 'https://metager.org/meta/meta.ger3?eingabe=%s';
            break;
        case "brave":
            search_url = 'https://search.brave.com/search?q=%s';
            break;
        case "custom":
            search_url = prompt('Full custom search engine URL, with %s in place of the query.', 'https://gg.fm/search?q=%s');
            break;
    }

    localStorage.setItem('search', search_url);
    localStorage.setItem('search_engine', search_value);
}

function main() {
    if (window.location.hash) {
        // Being called from the omnibox. Making a query.

        // Chrome URLencodes the query and passes it to the hash
        const hash = window.location.hash.substring(1);
        const query = decodeURIComponent(hash);
        let url = '';

        // User settings are stored in file:// localstorage
        const blacklist = JSON.parse(localStorage.getItem('blacklist'));
        const corrosion = localStorage.getItem('corrosion');
        const search = localStorage.getItem('search');
        const encoding = localStorage.getItem('encoding');

        if (query.startsWith('http://') || query.startsWith('https://')) {
            url = query; 
        } else {
            // Use the desired search engine if not a URL
            url = search.replace("%s", query);
        }

        // Don't use Corrosion for blacklisted URLs
        let domain = new URL(url);
        if (blacklist.includes(domain.hostname)) {
            window.location.href = url; 
            return;
        }

        let encoded_url = '';

        switch(encoding) {
            case 'xor':
                encoded_url = xor(url);
                break;
            case 'b64':
                encoded_url = btoa(url);
                break;
            case 'plain':
                encoded_url = url;
                break;
            default:
                encoded_url = xor(url);
                break;
        }

        // All done, redirect to the instance.
        window.location.href = corrosion + encoded_url;

    } else {
        // Being called directly. User is configuring options. 

        document.getElementById('options').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('url').href = document.URL + '#%s';
        document.getElementById('url').text = document.URL + '#%s';

        // Load in already set options & set defaults
        let blacklist_opt, corrosion_opt, search_engine_opt, encoding_opt = '';

        if (localStorage.getItem('blacklist') !== null) {
            blacklist_opt = JSON.parse(localStorage.getItem('blacklist')).join('\n'); 
        } else {
            blacklist_opt = 'wikipedia.org\ndictionary.com';
            setBlacklist(blacklist_opt);
        }

        if (localStorage.getItem('corrosion') !== null) {
            corrosion_opt = localStorage.getItem('corrosion'); 
        } else {
            corrosion_opt = 'https:///cdn.awardedu.org//search/';
            setCorrosion(corrosion_opt);
        }

        if (localStorage.getItem('search_engine') !== null) {
            search_engine_opt = localStorage.getItem('search_engine');
        } else {
            search_engine_opt = 'google';
            setSearch(search_engine_opt);
        }

        if (localStorage.getItem('encoding') !== null) {
            encoding_opt = localStorage.getItem('encoding');
        } else {
            encoding_opt = 'xor';
            setEncoding(encoding_opt);
        }

        document.getElementById('blacklist').value = blacklist_opt;
        document.getElementById('corrosion').value = corrosion_opt;
        document.getElementById(search_engine_opt).selected = 'selected';
        document.getElementById(encoding_opt).selected = 'selected';

        document.getElementById('blacklist-btn').addEventListener('click', () => {
            const blacklist_text = document.getElementById('blacklist').value;
            setBlacklist(blacklist_text);
        });

        document.getElementById('corrosion-btn').addEventListener('click', () => {
            const corrosion_text = document.getElementById('corrosion').value;
            setCorrosion(corrosion_text);
        });

        document.getElementById('search-btn').addEventListener('click', () => {
            const search_value = document.getElementById('search').value;
            setSearch(search_value);
        });

        document.getElementById('encoding-btn').addEventListener('click', () => {
            const encoding_value = document.getElementById('encoding').value;
            setEncoding(encoding_value);
        });

        document.getElementById('add').addEventListener('click', () => {
            document.getElementById('help').style.display = 'block';
        });
    }
}

main();
    </script>
</body>
</html>
